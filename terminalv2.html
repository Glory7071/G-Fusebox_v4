<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-Fuse Box | Stealth Ops</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --kali-green: #2ecc71; --kali-blue: #3498db; --kali-red: #e74c3c; --bg: #050505; }
        * { margin:0; padding:0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--kali-green); font-family: 'Fira Code', monospace; height: 100dvh; overflow: hidden; position: fixed; width: 100%; transition: background 0.3s; }

        /* HEADER */
        .system-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #111; border-bottom: 1px solid #333; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; 
        }
        .header-left { color: var(--kali-red); font-weight: bold; font-size: 13px; }
        .header-right { color: #f1c40f; font-weight: bold; font-size: 12px; }

        .help-hint { 
            position: fixed; top: 55px; left: 15px; font-size: 10px; color: #f1c40f; z-index: 999; 
            background: rgba(241, 196, 15, 0.05); padding: 2px 5px;
        }

        #terminal-container {
            margin-top: 50px; height: calc(100dvh - 50px);
            overflow-y: auto; padding: 35px 15px 300px 15px; 
            display: flex; flex-direction: column; gap: 6px;
        }
        .terminal-line { display: flex; align-items: flex-start; gap: 8px; font-size: 14px; }
        .prompt { color: var(--kali-blue); font-weight: bold; }
        .input-field { background: transparent; border: none; color: #fff; font-family: 'Fira Code', monospace; font-size: 14px; outline: none; flex: 1; }

        /* ATTACK ALERTS */
        .under-attack { animation: shake 0.15s infinite; background: rgba(231, 76, 60, 0.2) !important; }
        @keyframes shake { 0%{transform:translateX(3px)} 50%{transform:translateX(-3px)} }

        .hacked-card { background: rgba(46, 204, 113, 0.1); border: 1px solid var(--kali-green); padding: 10px; margin: 10px 0; border-radius: 8px; display: flex; align-items: center; gap: 12px; width: fit-content;}
        .hacked-img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; }
        
        .output { font-size: 13px; line-height: 1.4; }
        .danger { color: var(--kali-red); font-weight: bold; }
        .success { color: var(--kali-green); }
        .warning { color: #f1c40f; }
    </style>
</head>
<body oncontextmenu="return false;">

    <header class="system-header">
        <div class="header-left">üíÄ OPS: <span id="u-name" style="color:var(--kali-blue)">...</span></div>
        <div class="header-right">CORE XP: <span id="pts">0</span></div>
    </header>
    
    <div class="help-hint">CMD: scan-all | breach-unit [Name] | clear</div>

    <div id="terminal-container" onclick="document.getElementById('user-input').focus()">
        <div id="history-box"></div>
        <div class="terminal-line">
            <span class="prompt">root@GFuse:~#</span>
            <input type="text" class="input-field" id="user-input" autofocus autocomplete="off" spellcheck="false">
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDocs, collection, query, where, getDoc, deleteField, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAPDnqtVz3WqAj9sLBLDA0VnOzQ_pR0k", projectId: "ownproject-52911" };
    const db = getFirestore(initializeApp(firebaseConfig));
    
    // --- SECURITY ACCESS KEY ---
    const T_KEY = "G-FUSE-77"; 

    let myName = localStorage.getItem('current_session_user') || "Ghost";
    let myCurrentTarget = "";
    const historyBox = document.getElementById('history-box');
    const input = document.getElementById('user-input');
    const container = document.getElementById('terminal-container');

    let duelMode = false;
    let duelCode = "";
    let targetID = ""; 



    // --- SECURITY BLOCK START ---
    async function runSecurityCheck() {
        const screen = document.body;
        // 1. Referrer Check (Arena se hi aana chahiye)
        if (!document.referrer.includes("newerena") && !window.location.href.includes("bypass=true")) {
            screen.innerHTML = `<div style="background:#000; color:#e74c3c; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; padding:20px;">
                <h1 style="font-size:50px;">üö´ ACCESS DENIED</h1>
                <p>SECURE TUNNEL REQUIRED. PLEASE ENTER VIA THE ARENA PORTAL.</p>
                <small style="color:#555;">Error Code: REF_BYPASS_ERR</small>
            </div>`;
            return false;
        }
        // 2. Admin Master Switch Check
        const configSnap = await getDoc(doc(db, "settings", "terminal_config"));
        if (configSnap.exists() && configSnap.data().status === "OFFLINE") {
            screen.innerHTML = `<div style="background:#000; color:#f1c40f; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; padding:20px;">
                <h1 style="font-size:40px;">üîí SYSTEM LOCKED</h1>
                <p>TERMINAL IS CURRENTLY OFFLINE BY CENTRAL COMMAND.</p>
                <p style="color:#555;">Try again when the match is LIVE.</p>
            </div>`;
            return false;
        }
        return true;
    }
    // --- SECURITY BLOCK END ---
   async function init() {
        // Security Check Sabse Pehle
        const isAuthorized = await runSecurityCheck();
        if (!isAuthorized) return; 

        document.getElementById('u-name').innerText = myName;
        const userRef = doc(db, "cyber_war", myName);
        
        const updateStatus = async () => {
            try {
                await setDoc(userRef, { 
                    last_seen: Date.now(),
                    status: "IDLE",
                    terminal_key: T_KEY 
                }, { merge: true });
            } catch (e) { console.log("Heartbeat failed", e); }
        };

        await updateStatus();
        setInterval(updateStatus, 2000); 

        onSnapshot(doc(db, "cyber_war", "GLOBAL_META"), (s) => {});
        assignNewTarget();
        setInterval(assignNewTarget, 120000); 
    }

    async function assignNewTarget() {
        const snap = await getDocs(collection(db, "cyber_war"));
        let onlineUsers = [];
        snap.forEach(d => {
            if(d.data().last_seen > Date.now() - 20000 && d.id !== myName) onlineUsers.push(d.id);
        });
        if(onlineUsers.length > 0) {
            myCurrentTarget = onlineUsers[Math.floor(Math.random() * onlineUsers.length)];
            print("\n[!] NETWORK ENCRYPTION ROTATED. NEW TARGET VULNERABLE.", "warning");
        }
    }
     // --- PASTE THIS START ---
    // REAL-TIME KILL SWITCH (Bina refresh kiye lock karne ke liye)
    onSnapshot(doc(db, "settings", "terminal_config"), (s) => {
        const config = s.data();
        if (config && config.status === "OFFLINE") {
            document.body.innerHTML = `
                <div style="background:#000; color:#f1c40f; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:monospace; text-align:center; padding:20px;">
                    <h1 style="font-size:40px;">‚ö†Ô∏è SESSION TERMINATED</h1>
                    <p>CENTRAL COMMAND HAS TAKEN THE SYSTEM OFFLINE.</p>
                    <p style="color:#555; margin-top:10px;">All operations suspended.</p>
                </div>`;
            if(input) input.disabled = true;
        }
    });
    // --- PASTE THIS END ---
    async function updateXP(pts) {
        // Check if Admin locked the system while user was inside
        const configSnap = await getDoc(doc(db, "settings", "terminal_config"));
        if (configSnap.exists() && configSnap.data().status === "OFFLINE") {
            print("[!] SECURITY ALERT: Points Sync Disabled by Admin.", "danger");
            return;
        }

        const q = query(collection(db, "elite_units"), where("name", "==", myName));
        const usnap = await getDocs(q);
        if(!usnap.empty) {
            await updateDoc(doc(db, "elite_units", usnap.docs[0].id), { 
                points: increment(pts),
                terminal_key: T_KEY 
            });
        }
    }

    function print(text, type = '', isHTML = false) {
        const div = document.createElement('div');
        div.className = `output ${type}`;
        if(isHTML) div.innerHTML = text; else div.innerText = text;
        historyBox.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            const val = input.value.trim();
            input.value = '';
            if(!val) return;

            print(`<span class="prompt">root@GFuse:~#</span> ${val}`, '', true);

            if (duelMode) {
                if (val.toUpperCase() === duelCode) {
                    const activeTarget = (targetID !== "") ? targetID : myName;
                    const duelRef = doc(db, "cyber_war", activeTarget);
                    const snap = await getDoc(duelRef);
                    
                    if(snap.exists() && !snap.data().winner) {
                        await updateDoc(duelRef, { 
                            winner: myName,
                            terminal_key: T_KEY 
                        });

                        if(targetID !== "") {
    print("[+] BREACH SUCCESSFUL. +100 CORE XP SECURED.", "success");
    await updateXP(100);

    // FIX: Laptop aur Mobile ke case difference ko khatam karne ke liye query badal di
    const tQ = query(collection(db, "elite_units")); 
    const tSnap = await getDocs(tQ);
    
    let foundData = null;
    tSnap.forEach(doc => {
        // Dono ko lowercase karke match karo
        if(doc.data().name.toLowerCase() === targetID.toLowerCase()) {
            foundData = doc.data();
        }
    });

    if(foundData) {
        print(`
            <div class="hacked-card">
                <img src="${foundData.photo}" class="hacked-img" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=fallback'">
                <div>
                    <b>${foundData.name.toUpperCase()}</b><br>
                    <span class="danger">SYSTEM BREACHED</span><br>
                    <small style="color:var(--kali-blue)">DATA EXFILTRATED...</small>
                </div>
            </div>
        `, '', true);
    } else {
        // Agar photo na mile toh purana simple message
        print(`[+] NODE ${targetID.toUpperCase()} COMPROMISED.`, "success");
    }
    assignNewTarget();
} else {
                            print("[+] COUNTER-MEASURE SUCCESSFUL. ATTACK REPELLED.", "success");
                        }
                    }
                } else {
                    print("[!] INVALID CODE. FIREWALL STRENGTHENING...", "danger");
                }
                duelMode = false; targetID = ""; 
                return;
            }

            const args = val.toLowerCase().split(' ');
            
            if (args[0] === 'scan-all') {
                const snap = await getDocs(collection(db, "cyber_war"));
                print("--- SCANNING LIVE NODES ---", "warning");
                snap.forEach(d => {
                    if(d.data().last_seen > Date.now() - 60000 && d.id !== myName) {
                        print(`> NODE_ID: ${d.id} [ONLINE]`, "success");
                    }
                });
            } 
            else if (args[0] === 'breach-unit') {
    const guess = args[1];
    if(!guess) return print("[!] Usage: breach-unit [Name]", "warning");

    print(`[~] SEARCHING FOR NODE: ${guess.toUpperCase()}...`, "warning");

    // FIX: Laptop se Mobile ko dhoondne ke liye search query use karo
    const q = query(collection(db, "cyber_war"));
    const qSnap = await getDocs(q);
    
    let targetDoc = null;
    let tName = "";

    // Saare documents mein dhoondo (Case ka jhagda khatam)
    qSnap.forEach((doc) => {
        if(doc.id.toLowerCase() === guess.toLowerCase()) {
            targetDoc = doc.data();
            tName = doc.id;
        }
    });

    // Agar document mil gaya par time gap zyada hai
    if(!targetDoc) {
        return print(`[!] NODE ${guess.toUpperCase()} NOT FOUND.`, "danger");
    }

    if(targetDoc.last_seen < Date.now() - 90000) { // 90 sec buffer
        return print(`[!] NODE ${tName.toUpperCase()} IS OFFLINE (LATENCY).`, "danger");
    }

    // Ab Attack Logic
    if(tName.toLowerCase() === myCurrentTarget.toLowerCase()) {
        duelCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        targetID = tName; 
        duelMode = true;
        print(`[+] CONNECTION ESTABLISHED! CODE: ${duelCode}`, "success");
        
        await updateDoc(doc(db, "cyber_war", tName), { 
            status: "UNDER_ATTACK", 
            attacker: myName, 
            code: duelCode, 
            winner: null,
            terminal_key: T_KEY 
        });
    } else {
        print(`[!] ACCESS DENIED: ${tName.toUpperCase()} is not vulnerable.`, "danger");
        print(`[-] SECURITY TRACEBACK: -30 CORE XP`, "danger");
        await updateXP(-30);
        assignNewTarget(); 
    }
}
            else if (args[0] === 'clear') historyBox.innerHTML = '';
            else if (args[0] === 'whoami') print(myName, "success");
        }
    });

    onSnapshot(doc(db, "cyber_war", myName), async (s) => {
        const d = s.data();
        if(!d) return;

        if(d.status === "UNDER_ATTACK" && !d.winner) {
            document.body.classList.add('under-attack');
            duelMode = true; duelCode = d.code; targetID = ""; 
            print(`\n[!!!] SYSTEM BREACH DETECTED! TYPE CODE TO DEFEND: ${duelCode}`, "danger");
        } 
        else if (d.winner) {
            document.body.classList.remove('under-attack');
            if(d.winner !== myName) {
                print(`[!] HACKED BY ${d.winner.toUpperCase()}. PENALTY: -10 XP`, "danger");
                await updateXP(-10);
                setTimeout(() => {
                    updateDoc(doc(db, "cyber_war", myName), { 
                        status: "IDLE", 
                        winner: deleteField(),
                        terminal_key: T_KEY 
                    });
                }, 2000);
            }
            duelMode = false;
        }
    });

    onSnapshot(query(collection(db, "elite_units"), where("name", "==", myName)), (s) => {
        if(!s.empty) document.getElementById('pts').innerText = s.docs[0].data().points || 0;
    });

    init();
</script>
</body>
</html>
